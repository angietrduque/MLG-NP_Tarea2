---
title: 'Tarea 2: Modelos lineales generalizados y paramétricos'
author: "Angie Rodriguez Duque & Cesar Saavedra Vanegas"
date: "Octubre 22 de 2020"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
```{r warning=FALSE, include=F, paged.print=TRUE}
suppressMessages(library(dplyr))
suppressMessages(library(readxl))
suppressMessages(library(tidyverse))
suppressMessages(library(FactoMineR))
suppressMessages(library(factoextra))
suppressMessages(library(foreign))
suppressMessages(library(corrplot))
suppressMessages(library(polycor))
suppressMessages(library(psych))
suppressMessages(library(gplots))
suppressMessages(library(gridExtra))
suppressMessages(library(viridis))
suppressMessages(library(lsr))
suppressMessages(library(DescTools))
suppressMessages(library(magrittr))
suppressMessages(library(nlme))
suppressMessages(library(MASS))
suppressMessages(library(multilevel))
suppressMessages(library(reshape))
suppressMessages(library(homals))
suppressMessages(library(GGally))
suppressMessages(library(CCA))
suppressMessages(library(plotly))
suppressMessages(library(broom))
suppressMessages(library(readr))
suppressMessages(library(readxl))
```

# Actividad 1

## 

Se dispone de los tiempos de vida (tiempos hasta que fallan, en horas) de $49$ recipientes de presión sometidos a un nivel de carga del $70\%$

## Distribución Weibull

Para estudiar este tipo de variable se acostumbra utilizar la distribución de Weibull, cuya función de densidad es:

$$f(y;\lambda,\theta)=\displaystyle\frac{\lambda y^{\lambda-1}}{\theta^{\lambda}}exp \left[-\left(\frac{y}{\theta}\right)^{\lambda}\right] $$

Para analizar este problema usaremos el  método de Newton (conocido también como el método de Newton Raphson o el método de Newton Fourier), el cual es un algoritmo basado en la derivada que permite encontrar aproximaciones de los ceros o raíces de una función real derivable. En este caso particular se hara uso de la función U de scoring para la Weibul y se asumira $\lambda$ conocido y $U$ será el estimador $\hat\theta$ del parametro de escala $\theta$. 

1. Se elige $x_{0}$ en el eje de las $x$, asumiendo que está cerca de la solución de $f(x)=0$ (raíz buscada)

2. Calculamos la ecuación punto pendiente de la recta tangente a la función en $(x_{0},f(x_{0}))$, a saber $y−f(x_{0})=f′(x_{0})(x−x_{0})$ (1)

3. Esta recta debe intersecar al eje de las $x$, en un punto más cercano a la raíz buscada; en el punto $(x_{1},0)$.

4. El punto $(x_{1},0)$ satisface la ecuación (1) y sustituyendo, queda (2):
  $$0−f(x0)=f′(x0)(x−x0)$$
  
5. Si $f(x0)=0$, entonces despejando $x_{1}$ en (2) se obtiene:

$$x_{1}=x_{0}−\frac{f(x_{0})}{f′(x_{0})}$$

6. Repetimos el procedimiento anterior para $x_{0}$, pero ahora comenzando con $x_{1}$, en cuyo caso se obtiene $x_{2}=x_{1}−\frac{f(x_{1})}{f′(x_{1})}$. De forma que $x_{2}$ está más cerca de la raíz buscada que $x$.

7. Iterando cada vez con el número obtenido, se construye una secuencia: $x_{0},x_{1},x−2,…,x_{n},…$ de números cada vez más próximos a la raíz, tales que:
$$x_{n+1}=x_{n}−\frac{f(x_{n})}{f′(x_{n})}$$

Siguiendo este algoritmo y realizando su representación en R se obtienen los siguientes resultados para $\lambda=2$:## Función U de scoring para la Weibull

$$ \frac{dl}{d\theta}=U=\displaystyle\sum_{i=1}^{N}\left[ \frac{-\lambda}{\theta}+\frac{\lambda y^{\lambda}_{i}}{\theta^{\lambda+1}}\right]$$
Como asumimos que conocemos $\lambda$, la solución de $U=0$ será el estimador $\hat{\theta}$ del parámetro de escala $\theta$.

### Función U de scoring para la Weibull con $\lambda=2$

Como en este caso estamos asumiendo que $\lambda=2$, entonces la expresión anterior será aplicable en este caso.

$$U=\frac{2\cdot 36}{\theta}+\frac{2\cdot \displaystyle\sum_{i=1}^{36}y^{2}_{i}}{\theta^{3}}$$
Nos proponemos encontrar $\theta$ tal que $U=0$

### El método de Newton-Raphson

$$ \frac{dU}{d\theta}=U’=\displaystyle\sum_{i=1}^{N}\left[ \frac{\lambda}{\theta^{2}}+\frac{(\lambda) (\lambda-1) y^{\lambda}_{i}}{\theta^{\lambda+2}}\right]$$


<table>
| Interacción 	| $\lambda=1$ 	| $\lambda=1.5$ 	| $\lambda=2$ 	| $\lambda=2.5$ 	| $\lambda=3$ 	|
|:-----------:	|:-----------:	|:-------------:	|:-----------:	|:-------------:	|:-----------:	|
|      1      	|    368.26   	|     368.26    	|    368.26   	|     368.26    	|    368.26   	|
|      2      	|   401.618   	|    401.618    	|   401.618   	|    401.618    	|   401.618   	|
|      3      	|   410.9478  	|    410.9478   	|   410.9478  	|    410.9478   	|   410.9478  	|
|      4      	|   411.5225  	|    411.5225   	|   411.5225  	|    411.5225   	|   411.5225  	|
|      5      	|   411.5246  	|    411.5246   	|   411.5246  	|    411.5246   	|   411.5246  	|
|      6      	|   411.5246  	|    411.5246   	|   411.5246  	|    411.5246   	|   411.5246  	|


# Actividad 2

## Base de datos 

```{r warning=FALSE, include=F, paged.print=TRUE}
Datos <- read.table("Datos.txt",header=T,sep = ",")
Datos
```

```{r warning=FALSE, include=T, paged.print=TRUE}
dim(Datos)
```

Este conjunto de datos de vino tinto consta de 1599 observaciones y 12 variables, 11 de las cuales son sustancias químicas. Las variables son:

<div style="text-align: justify">

1. **Acidez fija:** La mayoría de los ácidos implicados en el vino son fijos o no volátiles (no se evaporan fácilmente).

2. **Acidez volátil:** La cantidad de ácido acético en el vino, que en niveles demasiado altos puede provocar un sabor desagradable a vinagre.

3. **Ácido cítrico:** Encontrado en pequeñas cantidades, el ácido cítrico puede agregar "frescura" y sabor a los vinos.

4. **Azúcar residual:** Es la cantidad de azúcar que queda después de que se detiene la fermentación, es raro encontrar vinos con menos de 1 gramo / litro y los vinos con más de 45 gramos / litro se consideran dulces.

5. **Cloruros:** Es la cantidad de sal del vino.

6. **Dióxido de azufre libre:** La forma libre de $SO_{2}$ existe en equilibrio entre el $SO_{2}$ molecular (como gas disuelto) y el ion bisulfito; Previene el crecimiento microbiano y la oxidación del vino.

7. **Dióxido de azufre total:** Es la cantidad de formas libres y unidas de $SO_{2}$; en concentraciones bajas, el $SO_{2}$ es mayormente indetectable en el vino, pero en concentraciones de $SO_{2}$ libre superiores a 50 ppm, el $SO_{2}$ se hace evidente en la nariz y el sabor del vino.

8. **Densidad:** La densidad es cercana a la del agua dependiendo del porcentaje de alcohol y contenido de azúcar.

9. **pH:** Describe qué tan ácido o básico es un vino en una escala de 0 (muy ácido) a 14 (muy básico); la mayoría de los vinos están entre 3-4 en la escala de pH.

10. **Sulfatos:** Aditivo del vino que puede contribuir a los niveles de dióxido de azufre $(SO_{2})$, que actúa como antimicrobiano y antioxidante.

11. **Alcohol:** El porcentaje de contenido de alcohol del vino.

12. **Calidad:** Variable de respuesta (basada en datos sensoriales, puntuación entre 0 y 10).

<div/>


## Estadísticas descriptivas

```{r warning=FALSE, include=T, paged.print=TRUE}
summary(Datos)
```

<center>
![Distribución de las variables](G1.png "Regresión local"){width=650px}

### Observaciones:

* Algunas de las variables tienen distribuciones normales (densidad, acidez fija, pH, acidez volátil).

* Algunas variables están un poco sesgadas hacia el extremo inferior de los valores (cloruros, ácido cítrico, azúcar residual, dióxido de azufre total).

* La variable calidad tiene solo 6 valores discretos.

```{r warning=FALSE, include=F, paged.print=TRUE}
G2 <- ggplot(Datos, aes(group = cut_width(quality, 1)))+ 
  geom_boxplot(aes(quality, fixed.acidity), colour = "#417b5a")+
  xlab("Calidad")+ylab("Acidez fija")
```


```{r fig.align="center", fig.height=3, fig.width=8, warning=FALSE, include=F}
G2
```


```{r fig.align="center", fig.height=5, fig.width=10, warning=FALSE, include=T}
corrplot(cor(Datos), method = "square")
```

* La densidad tiene una correlación muy fuerte con la acidez fija.

* Las variables más fuertemente correlacionadas con la calidad son la acidez volátil y el alcohol.

* El alcohol tiene una correlación negativa con la densidad. Esto es evidente por el hecho de que la densidad del agua es mayor que la densidad del alcohol.

## Variable indicadora: pHi 

Se convierte la variable "pH" en una variable indicadora con tres niveles: "alto", "medio" y "bajo", esta nueva variable se denomina: "pHi". Para dicha transformación se realiza el siguiente procedimiento:

$$Rango=\displaystyle\frac{Máx(pH)-Mín(pH)}{3}$$
$$Rango=\displaystyle\frac{4.01-2.74}{3}=0.4233333$$
De esta manera, los límites de cada intervalo son:

* $a = mín(pH)=2.74$
* $b = a + Rango=3.163333$
* $c = b + Rango=3.586667$
* $d = c + Rango=4.01$

<table>
| Nivel 	|      Criterio      	|       Intervalo       	| Conteo 	|
|:-----:	|:------------------:	|:---------------------:	|:------:	|
| Bajo  	| pH<b               	| $[2.74;3.163333)$     	|    267 	|
| Medio 	| pH $\geq$ b & pH<c 	| $[3.163333;3.586667)$ 	|   1269 	|
| Alto  	| pH $\geq$ c        	| $[3.586667;4.01)$      	|     63 	|

A partir de la siguiente figura es posible observar como el nivel de $pH$ con mayor frecuencia es aquel que se denomina como "medio" con 1269 observaciones, mientras que los niveles "bajo" y "alto", presentan frecuencias muy bajas, esto es, 267 y 63 respectivamente.

```{r warning=FALSE, include=F, paged.print=TRUE}
summary(Datos[,"pH"])
rango = (max(Datos$pH)-min(Datos$pH))/3
a = min(Datos$pH); a
b = a + rango; b
c = b + rango; c
d = c + rango; d
pHi <- vector() 
pHi[Datos$pH < b] <- "Bajo"
pHi[Datos$pH >= b & Datos$pH < c] <- "Medio"
pHi[Datos$pH > c] <- "Alto"
pHi <- as.factor(pHi)
```

```{r warning=FALSE, include=F, paged.print=TRUE}
G3 <- ggplot(data = Datos, aes(x=pHi, fill=pHi)) +
  geom_bar(position="dodge") + ylab("") + xlab(" ") +
  scale_fill_discrete(name = "Nivel pH:")
```

```{r fig.align="center", fig.height=2, fig.width=5, warning=FALSE, include=T}
G3
```

## Modelo lineal generalizado (GLM)
Los modelo lineal generalizado (GLM) es una generalización flexible de la regresión lineal ordinaria que permite variables de respuesta que tienen modelos de distribución de errores distintos de una distribución normal, fueron desarrollados por Nelder - Wedderburn (1972), permiten ampliar la gama de distribuciones de la variable respuesta a todas aquellas que pertenezcan a la familia exponencial de densidades.

Al igual que la regresión lineal múltiple, permite cumplir con dos objetivos, determinar si existe relación lineal entre las $xj$ y $y$ y cuál es su magnitud.

En esta sección, se ajustan dos modelos lineales generalizados, en primer lugar un modelo lineal generalizado usando como respuesta la variable "calidad" (quality) y como variables de predicción la variable "acidez fija" (fixed acidity) y en segundo lugar teniendo como variables predictoras las variables "acidez fija" (fixed acidity) y "pHi", tal como sigue:


## Modelo sin variable indicadora pHi

```{r warning=FALSE, include=T, paged.print=TRUE}
Modelo1 <- glm(Datos$quality ~ Datos$fixed.acidity, data=Datos)

```


$$Calidad=5.15732+0.05754*Acidezfija $$
<table> 
| Coeficientes 	| Estimación 	| Error estándar 	| Valor t 	|   $Pr(>|t|)$ 	| Significancia 	|
|:------------:	|:----------:	|:--------------:	|:-------:	|:------------:	|:-------------:	|
| Intercepto   	|    5.15732 	|        0.09789 	|  52.684 	|      < 2e-16 	|      ***      	|
| Acidez fija  	|    0.05754 	|        0.01152 	|   4.996 	|      6.5e-07 	|      ***      	|

## Modelo con variable indicadora pHi

```{r warning=FALSE, include=T, paged.print=TRUE}
Modelo2 <- glm(Datos$quality ~ Datos$fixed.acidity + pHi, data=Datos)
```


$$Calidad=5.03884+0.07194*Acidezfija-0.11957*pHiBajo+0.02348*pHiMedio$$
<table>
| Coeficientes 	| Estimación 	| Error estándar 	| Valor t 	|   $Pr(>|t|)$ 	| Significancia 	|
|:------------:	|:----------:	|:--------------:	|:-------:	|:------------:	|:-------------:	|
| Intercepto   	|    5.03884 	|        0.13061 	|  38.579 	|      < 2e-16 	|      ***      	|
| Acidez fija  	|    0.07194 	|        0.01365 	|   5.272 	|     1.54e-07 	|      ***      	|
| pHiBajo      	|   -0.11957 	|        0.12566 	|  -0.952 	|        0.341 	|               	|
| pHiMedio     	|    0.02348 	|        0.10672 	|   0.220 	|        0.826 	|               	|

De acuerdo a los resultados obtenidos y teniendo en cuenta que la interpretación de los valores p es similar a la del modelo lineal. Es posible evidenciar que la variable denominada "Acidez fija" es significativa en ambos modelos. Además, se encuentra positivamente relacionada con la variable de respuesta "Calidad", así la puntuación de la calidad del vino aumentaría $0.05754$ y $0.07194$ respectivamente por cada unidad que aumenta la acidez fija.

Finalmente, respecto al criterio de información empleado, esto es, el criterio de información de Akaike $(AIC)$, se tiene que mientras más pequeño sea el AIC, mejor se ajustará el modelo a los datos. De esta manera, el modelo que mejor se ajusta a los datos es el modelo con la variable indicadora pHi. 

<table>
| Sin pHi 	| Con pHi 	|
|:-------:	|:-------:	|
|  3834.5 	|   3833  	|

# Biblíografia 

* Dobson, A. J., & Barnett, A. G. (2018). An introduction to generalized linear models. CRC press.
